---
import Layout from '../layouts/Layout.astro';
import pb from '../utils/pb';

const user = (Astro.locals as any).user;

let commande: any = null;
let lignesCommande: any[] = [];
let prixTotal = 0;

if (user) {
  try {
    // FILTER PAR USER
    const commandes = await pb.collection('Commandes').getFullList({
      filter: `statut = "En_cours" && id_user = "${user.id}"`, 
      requestKey: null
    });
    
    if (commandes.length > 0) {
      commande = commandes[commandes.length - 1];
      
      lignesCommande = await pb.collection('Lignes_commande').getFullList({
        filter: `id_commandes = "${commande.id}"`,
        expand: 'id_creation,id_creation.id_modele',
        requestKey: null
      });

      prixTotal = lignesCommande.reduce((total, ligne) => {
        const prix = ligne.expand?.id_creation?.expand?.id_modele?.prix || 0;
        return total + (prix * ligne.quantite);
      }, 0);
    }
  } catch (err) {
    console.log('Erreur r√©cup√©ration panier:', err);
  }
}
---

<Layout title="Mon Panier">
  <div class="container mx-auto px-4 py-16">

    <!-- Bouton retour -->
    <div class="mb-8 flex justify-start">
      <button 
        onclick="history.back()" 
        class="flex items-center gap-2 text-base-content/70 hover:text-base-content transition"
      >
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
        </svg>
        Retour
      </button>
    </div>

    <h1 class="text-4xl font-display text-center mb-12">üõí Mon Panier</h1>

    {lignesCommande.length === 0 ? (
      <div class="text-center py-12">
        <p class="text-xl text-base-content/60 mb-6">Votre panier est vide</p>
        <a href="/creations" class="btn btn-accent">Retour √† ma collection</a>
      </div>
    ) : (
      <div class="grid lg:grid-cols-3 gap-8 max-w-6xl mx-auto">
        <!-- GAUCHE : Articles du panier -->
        <div class="lg:col-span-2 flex flex-col gap-4">
          {lignesCommande.map((ligne) => (
            <div class="bg-base-100 rounded border border-black/10 p-6">
              <div class="grid grid-cols-4 gap-4 items-start">
                <div class="col-span-1 flex items-center justify-center bg-base-200 rounded p-3 h-150px">
                <div class="w-30 h-30 flex items-center justify-center" set:html={ligne.expand?.id_creation?.svg} />
                </div>

                <div class="col-span-3 flex flex-col justify-between">
                  <div>
                    <h3 class="text-lg font-display mb-1">{ligne.expand?.id_creation?.nom_creation}</h3>
                    <p class="text-sm text-base-content/60">
                      Mod√®le : {ligne.expand?.id_creation?.expand?.id_modele?.nom_modele}
                    </p>
                  </div>

                  <div class="flex items-center justify-between mt-4">
                    <p class="text-2xl font-bold text-accent">
                      {(ligne.expand?.id_creation?.expand?.id_modele?.prix || 0).toFixed(2)}‚Ç¨
                    </p>
                    
                    <button 
                        id={`remove-${ligne.id}`}
                        class="btn btn-ghost btn-lg text-lg px-4 py-3"
                        data-ligne-id={ligne.id}
                    >
                        üóë Retirer
                    </button>
                  </div>
                </div>
              </div>
            </div>
          ))}
        </div>

        <!-- DROITE : R√©sum√© panier -->
        <div class="lg:col-span-1">
          <div class="bg-base-100 rounded border border-black/10 p-6 sticky top-20">
            <h2 class="text-xl font-display mb-4">R√©sum√©</h2>
            
            <div class="space-y-2 mb-6 pb-6 border-b border-base-300">
              <div class="flex justify-between text-sm">
                <span>{lignesCommande.length} article(s)</span>
                <span>{prixTotal.toFixed(2)}‚Ç¨</span>
              </div>
              <div class="flex justify-between text-sm text-base-content/60">
                <span>Frais de port</span>
                <span>Offerts</span>
              </div>
            </div>

            <div class="flex justify-between text-lg font-bold mb-6">
              <span>Total</span>
              <span class="text-accent">{prixTotal.toFixed(2)}‚Ç¨</span>
            </div>

            <button 
              id="validate-order"
              class="btn btn-accent btn-lg w-full"
            >
              ‚úÖ Valider la commande
            </button>

            <a 
              href="/creations" 
              class="btn btn-outline btn-lg w-full mt-2"
            >
              ‚Üê Continuer le shopping
            </a>
          </div>
        </div>
      </div>
    )}
  </div>

  <script define:vars={{ commandeId: commande?.id }}>
// ===== RETIRER UN ARTICLE =====
document.querySelectorAll('[id^="remove-"]').forEach(btn => {
  btn.addEventListener('click', async (e) => {
    e.preventDefault();
    
    // ‚úÖ CORRIGER : utiliser le bon data attribute
    const ligneId = btn.dataset.ligneId || e.target.closest('[data-ligne-id]')?.dataset.ligneId;
    
    console.log('üóë Retrait ligne:', ligneId);
    
    if (!ligneId) {
      alert('Erreur: ID ligne non trouv√©');
      return;
    }

    try {
      const response = await fetch('/apis/removeFromCart', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ ligneId })
      });

      const result = await response.json();
      if (result.success) {
        location.reload();
      } else {
        alert('Erreur:', result.error);
      }
    } catch (err) {
      console.error('Erreur retrait:', err);
      alert('Erreur lors du retrait');
    }
  });
});


    // Valider la commande
    document.getElementById('validate-order')?.addEventListener('click', async () => {
      try {
        const response = await fetch('/apis/validateOrder', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ commandeId })
        });

        const result = await response.json();
        if (result.success) {
          alert('‚úÖ Commande valid√©e !');
          window.location.href = '/';
        }
      } catch (err) {
        alert('Erreur lors de la validation');
      }
    });
  </script>
</Layout>
