---
import Layout from '../../layouts/Layout.astro';
import PersonnalisationTabs from '../../components/PersonnalisationTabs.astro';
import pb from '../../utils/pb';
import flecheIcon from '../../assets/svgs/fleche1.svg';

const id = Astro.params.id as string | undefined;
if (!id) {
  throw new Error('Missing model id');
}

const modele = await pb.collection('Modeles').getOne(id, {
  requestKey: null
});

const materiauxMonture = await pb.collection('Materiau').getFullList({
  filter: 'type_cible ~ "Monture"',
  requestKey: null
});

const materiauxVerres = await pb.collection('Materiau').getFullList({
  filter: 'type_cible ~ "Verres"',
  requestKey: null
});

const materiauxBranches = await pb.collection('Materiau').getFullList({
  filter: 'type_cible ~ "Branches"',
  requestKey: null
});

const modeleId = id;
---

<Layout title={`Personnaliser ${modele.nom_modele}`}>
  <div class="grid lg:grid-cols-3 pt-16">
    <!-- GAUCHE : Preview SVG (1/3) -->
    <div class="lg:col-span-1 flex items-center justify-center p-8 lg:p-12 bg-base-200 min-h-screen">
      <div id="svg-container" class="w-full max-w-sm">
        <div set:html={modele.svg} />
      </div>
    </div>

    <!-- DROITE : Options de personnalisation (2/3) -->
    <div class="lg:col-span-2 p-6 lg:p-16 flex flex-col">
      <h1 class="text-3xl lg:text-4xl font-display mb-2">Créez votre paire unique</h1>
      <p class="text-base-content/70 mb-8">
        Modèle sélectionné : <strong>{modele.nom_modele}</strong>
      </p>
      
      <PersonnalisationTabs 
        materiauxMonture={materiauxMonture}
        materiauxVerres={materiauxVerres}
        materiauxBranches={materiauxBranches}
      />

      <!-- ✅ NUDGE : Aversion à la perte -->
      <div class="alert alert-warning mt-6">
        <svg class="stroke-current shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
        </svg>
        <span><strong>Votre design unique n'est pas encore sauvegardé !</strong></span>
      </div>

      <!-- Boutons en bas à droite -->
      <div class="mt-auto flex items-center gap-4 justify-end pt-12">
        <button id="download-btn" class="btn btn-outline h-12 px-6" title="Télécharger en SVG">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
          </svg>
        </button>
        <button id="finalize-btn" class="btn btn-accent h-12 px-8 flex items-center gap-2">
          ✨ Sauvegarder ma création
          <img src={flecheIcon.src} alt="" class="w-5 h-5" />
        </button>
      </div>

      <!-- Modal de sauvegarde -->
      <dialog id="save-modal" class="modal">
        <div class="modal-box">
          <!-- ✅ NUDGE : Effet de dotation -->
          <h3 class="font-bold text-lg mb-2">Donnez un nom à votre création</h3>
          <p class="text-sm text-base-content/70 mb-4">Faites de cette paire votre création personnelle.</p>
          
          <input 
            type="text" 
            id="creation-name" 
            placeholder="Ex: Les lunettes de mes rêves..." 
            class="input input-bordered w-full mb-4"
          />
          
          <p class="text-xs text-center text-base-content/60 mb-4">
            Créez votre compte pour ne pas perdre ce design unique.
          </p>

          <div id="error-message" class="alert alert-error hidden mb-4">
            <span id="error-text"></span>
          </div>
          <div id="loading" class="hidden text-center py-4">
            <span class="loading loading-spinner loading-sm"></span>
          </div>
          <div class="modal-action">
            <button type="button" class="btn" onclick="document.getElementById('save-modal').close()" id="cancel-btn">
              Annuler
            </button>
            <button id="save-btn" type="button" class="btn btn-accent">
              Enregistrer ma création
            </button>
          </div>
        </div>
        <form method="dialog" class="modal-backdrop">
          <button>Fermer</button>
        </form>
      </dialog>
    </div>
  </div>
</Layout>

<script define:vars={{ modeleId }}>
  let hasUnsavedChanges = false;

  // ✅ NUDGE : Aversion à la perte (Confirmation de sortie)
  window.addEventListener('beforeunload', (e) => {
    if (hasUnsavedChanges) {
      e.preventDefault();
      e.returnValue = '';
    }
  });

  // Marquer comme modifié quand on change une couleur
  document.addEventListener('click', (e) => {
    if (e.target.closest('[data-color]')) {
      hasUnsavedChanges = true;
      
      // ✅ NUDGE : Feedback instantané
      const message = document.createElement('div');
      message.className = 'toast toast-top toast-end';
      message.innerHTML = `
        <div class="alert alert-success">
          <span>✨ Couleur appliquée !</span>
        </div>
      `;
      document.body.appendChild(message);
      setTimeout(() => message.remove(), 2000);
    }
  });

  // ===== BOUTON TÉLÉCHARGER =====
  document.getElementById('download-btn')?.addEventListener('click', () => {
    const svgContainer = document.getElementById('svg-container');
    const svgElement = svgContainer?.querySelector('svg');
    
    if (!svgElement) {
      alert('SVG non trouvé');
      return;
    }

    const svgContent = svgElement.outerHTML;
    const blob = new Blob([svgContent], { type: 'image/svg+xml;charset=utf-8' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'mes-lunettes.svg';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  });

  // ===== BOUTON FINALISER =====
  document.getElementById('finalize-btn')?.addEventListener('click', () => {
    document.getElementById('save-modal')?.showModal();
  });

  // ===== APPLIQUER LES COULEURS =====
  function applyColorsToSVG() {
    const montureBtn = document.querySelector('[data-partie="monture"].ring-4');
    const verresBtn = document.querySelector('[data-partie="verres"].ring-4');
    const branchesBtn = document.querySelector('[data-partie="branches"].ring-4');

    if (montureBtn) {
      document.querySelectorAll('#monture').forEach(el => {
        el.setAttribute('fill', `#${montureBtn.dataset.color}`);
      });
    }

    if (verresBtn) {
      document.querySelectorAll('.verre').forEach(el => {
        el.setAttribute('fill', `#${verresBtn.dataset.color}`);
      });
    }

    if (branchesBtn) {
      document.querySelectorAll('.branche').forEach(el => {
        el.setAttribute('fill', `#${branchesBtn.dataset.color}`);
      });
    }
  }

  // ===== BOUTON ENREGISTRER =====
  document.getElementById('save-btn')?.addEventListener('click', async () => {
    const nameInput = document.getElementById('creation-name');
    const name = nameInput.value.trim();
    const saveBtn = document.getElementById('save-btn');
    const cancelBtn = document.getElementById('cancel-btn');
    const errorDiv = document.getElementById('error-message');
    const errorText = document.getElementById('error-text');
    const loadingDiv = document.getElementById('loading');
    
    if (!name) {
      if (errorDiv && errorText) {
        errorText.textContent = 'Veuillez entrer un nom pour votre création';
        errorDiv.classList.remove('hidden');
      }
      return;
    }

    saveBtn.disabled = true;
    cancelBtn.disabled = true;
    saveBtn.textContent = 'Enregistrement...';
    errorDiv?.classList.add('hidden');
    loadingDiv?.classList.remove('hidden');

    try {
      applyColorsToSVG();

      const svgContainer = document.getElementById('svg-container');
      const svgElement = svgContainer?.querySelector('svg');
      const svgContent = svgElement?.outerHTML || '';

      const montureBtn = document.querySelector('[data-partie="monture"].ring-4');
      const verresBtn = document.querySelector('[data-partie="verres"].ring-4');
      const branchesBtn = document.querySelector('[data-partie="branches"].ring-4');

      const materiaux = [];
      
      if (montureBtn && montureBtn.dataset.color) {
        materiaux.push({
          code_valeur: montureBtn.dataset.color,
          partie_ciblee: 'monture'
        });
      }

      if (verresBtn && verresBtn.dataset.color) {
        materiaux.push({
          code_valeur: verresBtn.dataset.color,
          partie_ciblee: 'verres'
        });
      }

      if (branchesBtn && branchesBtn.dataset.color) {
        materiaux.push({
          code_valeur: branchesBtn.dataset.color,
          partie_ciblee: 'branches'
        });
      }

      const response = await fetch('/api/saveSVG', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          name: name,
          svg: svgContent,
          id_modele: modeleId,
          materiaux: materiaux
        })
      });

      const data = await response.json();

      if (data.success) {
        hasUnsavedChanges = false;
        window.location.href = `/creations/${data.id}`;
      } else {
        throw new Error(data.error || 'Erreur lors de la sauvegarde');
      }
    } catch (error) {
      console.error('Erreur:', error);
      if (errorDiv && errorText) {
        errorText.textContent = error instanceof Error ? error.message : 'Erreur lors de la sauvegarde';
        errorDiv.classList.remove('hidden');
      }
      saveBtn.disabled = false;
      cancelBtn.disabled = false;
      saveBtn.textContent = 'Enregistrer ma création';
      loadingDiv?.classList.add('hidden');
    }
  });
</script>
