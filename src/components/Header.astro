---
import tavueLogo from '../assets/svgs/tavue.svg';
import userIcon from '../assets/svgs/user.svg';
import panierIcon from '../assets/svgs/panier.svg';
import flecheIcon from '../assets/svgs/fleche1.svg';
import pb from '../utils/pb';

const user = (Astro.locals as any).user;

// RÃ©cupÃ©rer le nombre d'articles en panier (si connectÃ©)
let cartCount = 0;
if (user) {
  try {
    const commandes = await pb.collection('Commandes').getFullList({
      filter: `statut = "En_cours" && id_user = "${user.id}"`,
      requestKey: null
    });
    
    if (commandes.length > 0) {
      const lastCommande = commandes[commandes.length - 1];
      const lignes = await pb.collection('Lignes_commande').getFullList({
        filter: `id_commandes = "${lastCommande.id}"`,
        requestKey: null
      });
      cartCount = lignes.length;
    }
  } catch (err) {
    console.log('Erreur rÃ©cupÃ©ration panier:', err);
  }
}
---

<header class="fixed left-0 right-0 z-80 bg-base-100 border-b border-base-300 transition-all duration-300" id="main-header">
  <div class="container mx-auto px-4">
    <div class="flex items-center justify-between h-16">
      <!-- Menu hamburger (gauche) -->
      <button id="menu-toggle" class="relative z-90 flex flex-col gap-1 justify-center items-center w-8 h-8 focus:outline-none" aria-label="Menu">
        <span class="block bg-secondary h-0.5 transition-all duration-300 ease-in-out" style="width: 36px"></span>
        <span class="block bg-secondary h-0.5 transition-all duration-300 ease-in-out" style="width: 33px"></span>
        <span class="block bg-secondary h-0.5 transition-all duration-300 ease-in-out" style="width: 30px"></span>
      </button>

      <!-- Logo TAVUE (centrÃ©) -->
      <a href="/" class="absolute left-1/2 -translate-x-1/2">
        <img src={tavueLogo.src} alt="TAVUE" class="h-8" />
      </a>

      <!-- Actions droite -->
      <div class="flex items-center gap-4">
        <!-- Langues -->
        <div class="hidden lg:flex gap-2 text-sm">
          <button class="font-bold">FR</button>
          <span class="text-neutral">|</span>
          <button class="text-neutral hover:text-base-content">EN</button>
        </div>

        <!-- Panier avec badge (seulement connectÃ©) -->
        {user && (
          <a href="/panier" aria-label="Panier" class="relative">
            <img src={panierIcon.src} alt="Panier" class="w-6 h-6" />
            {cartCount > 0 && (
              <span class="absolute -top-2 -right-2 bg-accent text-accent-content text-xs font-bold w-5 h-5 rounded-full flex items-center justify-center">
                {cartCount}
              </span>
            )}
          </a>
        )}

        <!-- User Icon (Login/User menu) -->
        {!user ? (
          <a href="/login" aria-label="Se connecter">
            <img src={userIcon.src} alt="Connexion" class="w-6 h-6 hover:opacity-70 transition" />
          </a>
        ) : (
          <button id="user-menu-btn" aria-label="Menu utilisateur" class="hover:opacity-70 transition">
            <img src={userIcon.src} alt="Menu" class="w-6 h-6" />
          </button>
        )}
      </div>
    </div>
  </div>
</header>

<!-- Menu dÃ©pliant (gauche) -->
<div id="menu-slide" class="fixed top-0 left-0 h-full w-80 bg-base-100 shadow-2xl z-70 transform -translate-x-full transition-transform duration-300 ease-in-out">
  <div class="p-8 pt-20">
    <!-- âœ… MODÃˆLES Ã€ PERSONNALISER -->
    <h2 class="text-2xl font-display font-bold mb-8">Nos modÃ¨les</h2>
    <nav class="space-y-4 mb-12" id="menu-nav">
      <!-- ChargÃ© dynamiquement -->
    </nav>

    <!-- âœ… MENU UTILISATEUR (si connectÃ©) -->
    {user && (
      <>
        <div class="divider"></div>
        <h3 class="text-lg font-display mb-4">Mon compte</h3>
        <nav class="space-y-3 text-sm">
          <a 
            href="/creations" 
            class="flex items-center gap-2 hover:text-accent transition"
            onclick="document.getElementById('menu-toggle').click()"
          >
            ğŸ“ Ma collection
          </a>
          <a 
            href="/panier" 
            class="flex items-center gap-2 hover:text-accent transition"
            onclick="document.getElementById('menu-toggle').click()"
          >
            ğŸ›’ Mon panier {cartCount > 0 && <span class="badge badge-accent">{cartCount}</span>}
          </a>
          <a 
            href="/assistant-ai" 
            class="flex items-center gap-2 hover:text-accent transition"
            onclick="document.getElementById('menu-toggle').click()"
          >
            ğŸ¤– Assistant IA
          </a>
          <a 
            href="/commandes" 
            class="flex items-center gap-2 hover:text-accent transition"
            onclick="document.getElementById('menu-toggle').click()"
          >
            ğŸ“¦ Mes commandes
          </a>
          <button 
            id="logout-btn-menu"
            class="flex items-center gap-2 hover:text-error transition w-full mt-4"
          >
            ğŸšª Se dÃ©connecter
          </button>
        </nav>
      </>
    )}
  </div>
</div>

<!-- Overlay -->
<div id="menu-overlay" class="fixed inset-0 bg-black/50 z-65 opacity-0 pointer-events-none transition-opacity duration-300"></div>

<!-- Modal user menu (desktop) -->
{user && (
  <div id="user-menu-modal" class="fixed top-16 right-4 hidden">
    <div class="bg-base-100 rounded shadow-lg border border-base-300">
      <a href="/creations" class="block px-4 py-2 hover:bg-base-200">ğŸ“ Ma collection</a>
      <a href="/assistant-ai" class="block px-4 py-2 hover:bg-base-200">ğŸ¤– Assistant IA</a>
      <a href="/commandes" class="block px-4 py-2 hover:bg-base-200">ğŸ“¦ Mes commandes</a>
      <hr class="my-2" />
      <button id="logout-btn-desktop" class="block w-full text-left px-4 py-2 hover:bg-error/10 text-error">
        ğŸšª DÃ©connecter
      </button>
    </div>
  </div>
)}

<script>
  import pb from '../utils/pb';
  import flecheUrl from '../assets/svgs/fleche1.svg';

  const menuToggle = document.getElementById('menu-toggle');
  const menuSlide = document.getElementById('menu-slide');
  const menuOverlay = document.getElementById('menu-overlay');
  const menuNav = document.getElementById('menu-nav');
  const spans = menuToggle?.querySelectorAll('span');
  const userMenuBtn = document.getElementById('user-menu-btn');
  const userMenuModal = document.getElementById('user-menu-modal');
  const logoutBtnMenu = document.getElementById('logout-btn-menu');
  const logoutBtnDesktop = document.getElementById('logout-btn-desktop');

  let menuOpen = false;

  // Charger les modÃ¨les
  async function loadMenuModels() {
    try {
      const modeles = await pb.collection('Modeles').getFullList({
        sort: 'created',
      });

      menuNav!.innerHTML = modeles.map(modele => `
        <a 
          href="/personnalisation/${modele.id}"
          class="flex items-center justify-between group hover:translate-x-2 transition-transform data-model-link"
        >
          <span class="text-lg">${modele.nom_modele}</span>
          <img src="${flecheUrl.src}" alt="" class="w-6 h-6 opacity-0 group-hover:opacity-100 transition-opacity" />
        </a>
      `).join('');

      document.querySelectorAll('[data-model-link]').forEach(link => {
        link.addEventListener('click', toggleMenu);
      });
    } catch (error) {
      console.error('Erreur chargement menu:', error);
    }
  }

  function toggleMenu() {
    if (menuOpen) {
      if (spans) {
        spans[0].style.transform = 'rotate(0deg)';
        spans[0].style.width = '36px';
        spans[1].style.opacity = '1';
        spans[1].style.width = '33px';
        spans[2].style.transform = 'rotate(0deg)';
        spans[2].style.width = '30px';
      }
      menuSlide?.classList.add('-translate-x-full');
      menuOverlay?.classList.add('opacity-0', 'pointer-events-none');
      menuOpen = false;
    } else {
      menuSlide?.classList.remove('-translate-x-full');
      menuOverlay?.classList.remove('opacity-0', 'pointer-events-none');
      
      if (spans) {
        spans[0].style.transform = 'rotate(45deg) translateY(5px)';
        spans[0].style.width = '36px';
        spans[1].style.opacity = '0';
        spans[1].style.width = '36px';
        spans[2].style.transform = 'rotate(-45deg) translateY(-5px)';
        spans[2].style.width = '36px';
      }
      menuOpen = true;
    }
  }

  // Toggle user menu (desktop)
  userMenuBtn?.addEventListener('click', () => {
    userMenuModal?.classList.toggle('hidden');
  });

  // Logout
  async function handleLogout() {
    try {
      await fetch('/api/auth/logout', { method: 'POST' });
      window.location.href = '/';
    } catch (err) {
      console.error('Erreur logout:', err);
    }
  }

  logoutBtnMenu?.addEventListener('click', handleLogout);
  logoutBtnDesktop?.addEventListener('click', handleLogout);

  loadMenuModels();
  menuToggle?.addEventListener('click', toggleMenu);
  menuOverlay?.addEventListener('click', toggleMenu);
</script>
