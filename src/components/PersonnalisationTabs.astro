---
import type { MateriauResponse } from '../utils/pocketbase-types';

interface Props {
  materiauxMonture: MateriauResponse[];
  materiauxVerres: MateriauResponse[];
  materiauxBranches: MateriauResponse[];
}

const { materiauxMonture, materiauxVerres, materiauxBranches } = Astro.props;
---

<div class="personnalisation-container">
  <!-- Les 3 boutons tabs -->
  <div class="flex gap-2 md:gap-3 mb-6 md:mb-8 overflow-hidden">
    <button 
      data-tab="monture" 
      class="tab-btn py-3 md:py-4 px-4 md:px-8 rounded-lg font-display text-base md:text-xl bg-accent text-white transition-all duration-300 flex-2"
    >
      Monture
    </button>
    <button 
      data-tab="verres" 
      class="tab-btn py-3 md:py-4 px-4 md:px-8 rounded-lg font-display text-base md:text-xl bg-secondary text-white transition-all duration-300 flex-1"
    >
      Verres
    </button>
    <button 
      data-tab="branches" 
      class="tab-btn py-3 md:py-4 px-4 md:px-8 rounded-lg font-display text-base md:text-xl bg-secondary text-white transition-all duration-300 flex-1"
    >
      Branches
    </button>
  </div>

  <!-- Contenu des tabs -->
  <div class="bg-base-200 p-4 md:p-8 rounded-lg min-h-[300px] md:min-h-[400px]">
    <!-- Tab Monture (visible par défaut) -->
    <div id="tab-monture" class="tab-content block">
      <h3 class="text-lg md:text-2xl font-display mb-4 md:mb-6">Quel style vous correspond ?</h3>
      <div class="grid grid-rows-3 grid-flow-col gap-1 md:gap-4 auto-cols-max">
        {materiauxMonture.map((mat) => (
          <button 
            class="color-btn w-12 h-12 md:w-16 md:h-16 rounded-full  hover:scale-110 transition-transform"
            style={`background-color: #${mat.code_valeur}`}
            data-color={mat.code_valeur}
            data-partie="monture"
            title={mat.libelle}
          />
        ))}
      </div>
    </div>

    <!-- Tab Verres (caché) -->
    <div id="tab-verres" class="tab-content hidden">
      <h3 class="text-lg md:text-2xl font-display mb-3 md:mb-6">Verres "classiques"</h3>
      <p class="text-xs md:text-sm mb-3 md:mb-4">Des verres simples, facilement nettoyables.</p>
      
      <h4 class="text-base md:text-xl font-display mt-6 md:mt-8 mb-2 md:mb-3">Verres anti-lumière bleue</h4>
      <p class="text-xs md:text-sm mb-3 md:mb-4">Filtre anti-lumière bleue pour écrans.</p>
      
      <h4 class="text-base md:text-xl font-display mt-6 md:mt-8 mb-2 md:mb-3">Verres Teintés</h4>
      <p class="text-xs md:text-sm mb-4 md:mb-6">Pour voir la vie de toutes les couleurs !</p>
      
      <div class="grid grid-cols-4 md:grid-cols-8 gap-2 md:gap-4 mt-4 md:mt-6">
        {materiauxVerres.map((mat) => (
          <button 
            class="color-btn w-12 h-12 md:w-16 md:h-16 rounded-lg border hover:scale-110 transition-transform"
            style={`background-color: #${mat.code_valeur}`}
            data-color={mat.code_valeur}
            data-partie="verres"
            title={mat.libelle}
          />
        ))}
      </div>
    </div>

    <!-- Tab Branches (caché) -->
    <div id="tab-branches" class="tab-content hidden">
      <h3 class="text-lg md:text-2xl font-display mb-4 md:mb-6">Ajoutez une touche personnelle !</h3>
      <div class="grid grid-rows-3 grid-flow-col gap-1 md:gap-4 auto-cols-max">
        {materiauxBranches.map((mat) => (
          <button 
            class="color-btn w-12 h-12 md:w-16 md:h-16 rounded-full hover:scale-110 transition-transform"
            style={`background-color: #${mat.code_valeur}`}
            data-color={mat.code_valeur}
            data-partie="branches"
            title={mat.libelle}
          />
        ))}
      </div>
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const buttons = document.querySelectorAll('.tab-btn');
    const contents = document.querySelectorAll('.tab-content');

    function updateTabSizes() {
      buttons.forEach(button => {
        if (button.classList.contains('bg-accent')) {
          // Actif = flex-[2] (66%)
          button.classList.add('flex-[2]');
          button.classList.remove('flex-1');
        } else {
          // Inactif = flex-1 (33%)
          button.classList.add('flex-1');
          button.classList.remove('flex-[2]');
        }
      });
    }

    buttons.forEach(button => {
      button.addEventListener('click', () => {
        const targetTab = button.getAttribute('data-tab');
        
        // Reset boutons
        buttons.forEach(btn => {
          btn.classList.remove('bg-accent');
          btn.classList.add('bg-secondary');
        });
        
        button.classList.remove('bg-secondary');
        button.classList.add('bg-accent');
        
        // Update flex sizes
        updateTabSizes();
        
        // Cache tout
        contents.forEach(content => {
          content.classList.remove('block');
          content.classList.add('hidden');
        });
        
        // Affiche le bon
        const targetContent = document.getElementById(`tab-${targetTab}`);
        if (targetContent) {
          targetContent.classList.remove('hidden');
          targetContent.classList.add('block');
        }
      });
    });

    // Init sizes on load
    updateTabSizes();

    // Couleurs
    const colorButtons = document.querySelectorAll('.color-btn');

    colorButtons.forEach((el) => {
      const button = el as HTMLElement;
      button.addEventListener('click', (e) => {
        e.stopPropagation();
        
        const color = button.dataset?.color ?? '';
        const partie = button.dataset?.partie ?? '';
        
        let selector = '';
        
        if (partie === 'monture') {
          selector = '#monture';
        } else if (partie === 'verres') {
          selector = '.verre';
        } else if (partie === 'branches') {
          selector = '.branche';
        }
        
        const elements = selector ? document.querySelectorAll(selector) : [];
        elements.forEach(el => {
          if (el instanceof Element) {
            (el as Element).setAttribute('fill', `#${color}`);
          }
        });

        document.querySelectorAll(`[data-partie="${partie}"]`).forEach(btn => {
          if (btn instanceof Element) {
            btn.classList.remove('ring-4', 'ring-accent');
          }
        });
        button.classList.add('ring-4', 'ring-accent');
      });
    });
  });
</script>
